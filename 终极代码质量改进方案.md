# ç»ˆæä»£ç è´¨é‡æ”¹è¿›æ–¹æ¡ˆ

## ğŸ¯ æ ¸å¿ƒé—®é¢˜è§£å†³

### âœ… å·²ä¿®å¤çš„å…³é”®é—®é¢˜
1. **'NoneType' object is not callable é”™è¯¯**
   - åˆ›å»ºäº†ç»Ÿä¸€çš„ `_safe_log()` å·¥å…·å‡½æ•°
   - æ¶ˆé™¤äº†æ‰€æœ‰ä¸å®‰å…¨çš„æ—¥å¿—è°ƒç”¨æ¨¡å¼
   - å®ç°äº†å®Œå…¨çš„å¼‚å¸¸å®‰å…¨ä¿éšœ

2. **ä»£ç é‡å¤é—®é¢˜**
   - ç»Ÿä¸€äº†æ—¥å¿—è®°å½•é€»è¾‘
   - å‡å°‘äº†ç»´æŠ¤æˆæœ¬

## ğŸš€ è¿›é˜¶ä»£ç è´¨é‡æ”¹è¿›å»ºè®®

### 1. ç±»å‹å®‰å…¨ä¸æ³¨è§£å¢å¼º

```python
from typing import Protocol, TypedDict, Literal
from dataclasses import dataclass
from enum import Enum

class LoggerProtocol(Protocol):
    """Loggeræ¥å£åè®®"""
    def info(self, message: str) -> None: ...
    def error(self, message: str) -> None: ...
    def warning(self, message: str) -> None: ...

class TestResult(TypedDict):
    url: str
    status_code: int | str
    response_time: float | str
    result: str
    success: bool

class TestType(Enum):
    BASIC = "basic"
    API = "api"
    ALL = "all"

@dataclass
class TestConfig:
    timeout: int = 10
    test_type: TestType = TestType.ALL
    verbose: bool = True
    max_retries: int = 3
    retry_delay: float = 1.0
```

### 2. é…ç½®ç®¡ç†ç³»ç»Ÿ

```python
import os
from pathlib import Path
import yaml
from typing import Dict, Any

class ConfigManager:
    """é…ç½®ç®¡ç†å™¨"""
    
    def __init__(self, config_file: str = "config.yaml"):
        self.config_file = Path(config_file)
        self.config = self._load_config()
    
    def _load_config(self) -> Dict[str, Any]:
        """åŠ è½½é…ç½®æ–‡ä»¶"""
        if self.config_file.exists():
            with open(self.config_file, 'r', encoding='utf-8') as f:
                return yaml.safe_load(f) or {}
        return self._get_default_config()
    
    def _get_default_config(self) -> Dict[str, Any]:
        """è·å–é»˜è®¤é…ç½®"""
        return {
            'timeout': int(os.getenv('COZE_TIMEOUT', '10')),
            'max_retries': int(os.getenv('COZE_MAX_RETRIES', '3')),
            'retry_delay': float(os.getenv('COZE_RETRY_DELAY', '1.0')),
            'test_urls': [
                "https://api.coze.com/v1/chat",
                "https://api.coze.com/v1/workflows/chat",
                "https://api.coze.com/v1/workflows/run",
                "https://api.coze.com/open_api/v2/chat",
                "https://www.coze.com"
            ],
            'user_agent': 'CozeConnectivityTester/2.0'
        }
    
    def get(self, key: str, default=None):
        """è·å–é…ç½®å€¼"""
        return self.config.get(key, default)
```

### 3. é‡è¯•æœºåˆ¶ä¸é”™è¯¯æ¢å¤

```python
import time
from functools import wraps
from typing import Callable, TypeVar, Any

T = TypeVar('T')

def retry_on_failure(max_retries: int = 3, delay: float = 1.0, 
                    exceptions: tuple = (Exception,)):
    """é‡è¯•è£…é¥°å™¨"""
    def decorator(func: Callable[..., T]) -> Callable[..., T]:
        @wraps(func)
        def wrapper(*args, **kwargs) -> T:
            last_exception = None
            
            for attempt in range(max_retries + 1):
                try:
                    return func(*args, **kwargs)
                except exceptions as e:
                    last_exception = e
                    if attempt < max_retries:
                        time.sleep(delay * (2 ** attempt))  # æŒ‡æ•°é€€é¿
                        continue
                    break
            
            raise last_exception
        return wrapper
    return decorator

class EnhancedCozeConnectivityTester(CozeConnectivityTester):
    """å¢å¼ºç‰ˆè¿é€šæ€§æµ‹è¯•å™¨"""
    
    def __init__(self, logger=None, config_manager: ConfigManager = None):
        self.config = config_manager or ConfigManager()
        super().__init__(logger, self.config.get('timeout', 10))
        self.max_retries = self.config.get('max_retries', 3)
        self.retry_delay = self.config.get('retry_delay', 1.0)
    
    @retry_on_failure(max_retries=3, delay=1.0, 
                     exceptions=(requests.exceptions.Timeout, 
                               requests.exceptions.ConnectionError))
    def _test_single_url_with_retry(self, url: str) -> Dict[str, Any]:
        """å¸¦é‡è¯•çš„URLæµ‹è¯•"""
        return super()._test_single_url(url)
```

### 4. æ€§èƒ½ç›‘æ§ä¸æŒ‡æ ‡æ”¶é›†

```python
import time
from contextlib import contextmanager
from typing import Dict, List
from dataclasses import dataclass, field
from datetime import datetime

@dataclass
class PerformanceMetrics:
    """æ€§èƒ½æŒ‡æ ‡"""
    total_tests: int = 0
    successful_tests: int = 0
    failed_tests: int = 0
    total_time: float = 0.0
    average_response_time: float = 0.0
    fastest_response: float = float('inf')
    slowest_response: float = 0.0
    error_rates: Dict[str, int] = field(default_factory=dict)
    
    def update(self, response_time: float, success: bool, error_type: str = None):
        """æ›´æ–°æŒ‡æ ‡"""
        self.total_tests += 1
        self.total_time += response_time
        
        if success:
            self.successful_tests += 1
            self.fastest_response = min(self.fastest_response, response_time)
            self.slowest_response = max(self.slowest_response, response_time)
        else:
            self.failed_tests += 1
            if error_type:
                self.error_rates[error_type] = self.error_rates.get(error_type, 0) + 1
        
        self.average_response_time = self.total_time / self.total_tests
    
    def get_summary(self) -> Dict[str, Any]:
        """è·å–æŒ‡æ ‡æ‘˜è¦"""
        return {
            'total_tests': self.total_tests,
            'success_rate': self.successful_tests / self.total_tests if self.total_tests > 0 else 0,
            'average_response_time': round(self.average_response_time, 3),
            'fastest_response': round(self.fastest_response, 3) if self.fastest_response != float('inf') else 0,
            'slowest_response': round(self.slowest_response, 3),
            'error_distribution': self.error_rates
        }

@contextmanager
def measure_time():
    """æ—¶é—´æµ‹é‡ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
    start = time.time()
    yield
    end = time.time()
    return end - start
```

### 5. ç¼“å­˜æœºåˆ¶

```python
import pickle
from pathlib import Path
from typing import Optional, Any
from datetime import datetime, timedelta

class ResultCache:
    """ç»“æœç¼“å­˜ç®¡ç†å™¨"""
    
    def __init__(self, cache_dir: str = ".cache", ttl_minutes: int = 30):
        self.cache_dir = Path(cache_dir)
        self.cache_dir.mkdir(exist_ok=True)
        self.ttl = timedelta(minutes=ttl_minutes)
    
    def _get_cache_file(self, key: str) -> Path:
        """è·å–ç¼“å­˜æ–‡ä»¶è·¯å¾„"""
        return self.cache_dir / f"{key}.cache"
    
    def get(self, key: str) -> Optional[Any]:
        """è·å–ç¼“å­˜"""
        cache_file = self._get_cache_file(key)
        
        if not cache_file.exists():
            return None
        
        # æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
        if datetime.now() - datetime.fromtimestamp(cache_file.stat().st_mtime) > self.ttl:
            cache_file.unlink()
            return None
        
        try:
            with open(cache_file, 'rb') as f:
                return pickle.load(f)
        except Exception:
            return None
    
    def set(self, key: str, value: Any) -> None:
        """è®¾ç½®ç¼“å­˜"""
        cache_file = self._get_cache_file(key)
        
        try:
            with open(cache_file, 'wb') as f:
                pickle.dump(value, f)
        except Exception:
            pass  # ç¼“å­˜å¤±è´¥ä¸å½±å“ä¸»è¦åŠŸèƒ½
    
    def clear(self) -> None:
        """æ¸…ç©ºç¼“å­˜"""
        for cache_file in self.cache_dir.glob("*.cache"):
            cache_file.unlink()
```

### 6. å•å…ƒæµ‹è¯•æ¡†æ¶

```python
import unittest
from unittest.mock import Mock, patch, MagicMock
import requests

class TestCozeConnectivityTester(unittest.TestCase):
    """è¿é€šæ€§æµ‹è¯•å™¨å•å…ƒæµ‹è¯•"""
    
    def setUp(self):
        """æµ‹è¯•è®¾ç½®"""
        self.mock_logger = Mock()
        self.tester = CozeConnectivityTester(logger=self.mock_logger, timeout=5)
    
    def test_safe_log_with_valid_logger(self):
        """æµ‹è¯•æœ‰æ•ˆloggerçš„å®‰å…¨æ—¥å¿—è®°å½•"""
        _safe_log(self.mock_logger, "test message", "info")
        self.mock_logger.info.assert_called_once_with("test message")
    
    def test_safe_log_with_none_logger(self):
        """æµ‹è¯•None loggerçš„å®‰å…¨æ—¥å¿—è®°å½•"""
        with patch('builtins.print') as mock_print:
            _safe_log(None, "test message", "info")
            mock_print.assert_called_once_with("[INFO] test message")
    
    @patch('requests.get')
    def test_successful_url_test(self, mock_get):
        """æµ‹è¯•æˆåŠŸçš„URLæµ‹è¯•"""
        mock_response = Mock()
        mock_response.status_code = 200
        mock_response.elapsed.total_seconds.return_value = 1.5
        mock_get.return_value = mock_response
        
        result = self.tester._test_single_url("https://example.com")
        
        self.assertTrue(result['success'])
        self.assertEqual(result['status_code'], 200)
        self.assertEqual(result['response_time'], 1.5)
    
    @patch('requests.get')
    def test_timeout_handling(self, mock_get):
        """æµ‹è¯•è¶…æ—¶å¤„ç†"""
        mock_get.side_effect = requests.exceptions.Timeout()
        
        result = self.tester._test_single_url("https://example.com")
        
        self.assertFalse(result['success'])
        self.assertEqual(result['status_code'], 'TIMEOUT')
    
    def test_handler_with_mock_args(self):
        """æµ‹è¯•handlerå‡½æ•°"""
        mock_args = Mock()
        mock_args.input = {'test_type': 'basic', 'timeout': 5, 'verbose': False}
        mock_args.logger = self.mock_logger
        
        with patch.object(CozeConnectivityTester, 'test_basic_connectivity') as mock_test:
            mock_test.return_value = []
            
            result = handler(mock_args)
            
            self.assertTrue(result['success'])
            self.assertIsInstance(result, dict)

if __name__ == '__main__':
    unittest.main()
```

### 7. æ—¥å¿—ç³»ç»Ÿå¢å¼º

```python
import logging
from logging.handlers import RotatingFileHandler
from pathlib import Path
import json
from datetime import datetime

class StructuredLogger:
    """ç»“æ„åŒ–æ—¥å¿—è®°å½•å™¨"""
    
    def __init__(self, name: str = "coze_tester", log_dir: str = "logs"):
        self.logger = logging.getLogger(name)
        self.logger.setLevel(logging.INFO)
        
        # åˆ›å»ºæ—¥å¿—ç›®å½•
        log_path = Path(log_dir)
        log_path.mkdir(exist_ok=True)
        
        # æ–‡ä»¶å¤„ç†å™¨
        file_handler = RotatingFileHandler(
            log_path / "coze_tester.log",
            maxBytes=10*1024*1024,  # 10MB
            backupCount=5
        )
        
        # JSONæ ¼å¼åŒ–å™¨
        formatter = logging.Formatter(
            '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
        )
        file_handler.setFormatter(formatter)
        
        self.logger.addHandler(file_handler)
    
    def log_structured(self, level: str, message: str, **kwargs):
        """è®°å½•ç»“æ„åŒ–æ—¥å¿—"""
        log_data = {
            'timestamp': datetime.now().isoformat(),
            'message': message,
            **kwargs
        }
        
        getattr(self.logger, level)(json.dumps(log_data, ensure_ascii=False))
    
    def log_test_result(self, url: str, result: Dict[str, Any]):
        """è®°å½•æµ‹è¯•ç»“æœ"""
        self.log_structured(
            'info',
            'URLæµ‹è¯•å®Œæˆ',
            url=url,
            status_code=result.get('status_code'),
            response_time=result.get('response_time'),
            success=result.get('success')
        )
```

## ğŸ“‹ å®æ–½ä¼˜å…ˆçº§

### ğŸ”¥ é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å®æ–½ï¼‰
1. âœ… ç»Ÿä¸€æ—¥å¿—è®°å½•æœºåˆ¶ï¼ˆå·²å®Œæˆï¼‰
2. é…ç½®ç®¡ç†ç³»ç»Ÿ
3. åŸºç¡€å•å…ƒæµ‹è¯•
4. ç±»å‹æ³¨è§£å¢å¼º

### ğŸ”¶ ä¸­ä¼˜å…ˆçº§ï¼ˆçŸ­æœŸå†…å®æ–½ï¼‰
1. é‡è¯•æœºåˆ¶
2. æ€§èƒ½ç›‘æ§
3. ç»“æ„åŒ–æ—¥å¿—
4. é”™è¯¯å¤„ç†å¢å¼º

### ğŸ”µ ä½ä¼˜å…ˆçº§ï¼ˆé•¿æœŸè§„åˆ’ï¼‰
1. ç¼“å­˜æœºåˆ¶
2. é«˜çº§ç›‘æ§æŒ‡æ ‡
3. è‡ªåŠ¨åŒ–æµ‹è¯•é›†æˆ
4. æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ

## ğŸ¯ é¢„æœŸæ”¶ç›Š

### å¯é æ€§æå‡
- æ¶ˆé™¤æ‰€æœ‰å·²çŸ¥çš„ NoneType é”™è¯¯
- å¢å¼ºå¼‚å¸¸å¤„ç†å’Œé”™è¯¯æ¢å¤
- æä¾›é‡è¯•æœºåˆ¶å’Œæ•…éšœè½¬ç§»

### å¯ç»´æŠ¤æ€§æ”¹è¿›
- ç»Ÿä¸€çš„ä»£ç é£æ ¼å’Œæ¨¡å¼
- å®Œæ•´çš„ç±»å‹æ³¨è§£
- å…¨é¢çš„å•å…ƒæµ‹è¯•è¦†ç›–

### æ€§èƒ½ä¼˜åŒ–
- ç¼“å­˜æœºåˆ¶å‡å°‘é‡å¤è¯·æ±‚
- æ€§èƒ½ç›‘æ§è¯†åˆ«ç“¶é¢ˆ
- é…ç½®ä¼˜åŒ–æå‡å“åº”é€Ÿåº¦

### å¯è§‚æµ‹æ€§å¢å¼º
- ç»“æ„åŒ–æ—¥å¿—ä¾¿äºåˆ†æ
- è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡
- å®æ—¶ç›‘æ§å’Œå‘Šè­¦

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³è¡ŒåŠ¨**ï¼šå®æ–½é…ç½®ç®¡ç†ç³»ç»Ÿ
2. **æœ¬å‘¨å†…**ï¼šæ·»åŠ åŸºç¡€å•å…ƒæµ‹è¯•
3. **æœ¬æœˆå†…**ï¼šå®Œæˆé‡è¯•æœºåˆ¶å’Œæ€§èƒ½ç›‘æ§
4. **æŒç»­æ”¹è¿›**ï¼šæ ¹æ®ä½¿ç”¨åé¦ˆä¼˜åŒ–åŠŸèƒ½

---

*æ­¤æ–¹æ¡ˆåŸºäºå½“å‰ä»£ç çŠ¶æ€åˆ¶å®šï¼Œæ—¨åœ¨æä¾›å…¨é¢çš„è´¨é‡æ”¹è¿›è·¯å¾„ã€‚å»ºè®®æ ¹æ®å®é™…éœ€æ±‚å’Œèµ„æºæƒ…å†µåˆ†é˜¶æ®µå®æ–½ã€‚*